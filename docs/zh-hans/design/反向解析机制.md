# 反向解析机制

## 术语约定
* 地址：指 CKB 钱包地址；
* 私钥: 指 CKB 钱包私钥；
* DAS：指 decentralized account system 的缩写；
* 账户名：指 DAS 中的账户名，比如 someone.bit；
* 正向解析：指通过账户名获取地址；
* 反向解析：指通过地址获取账户名；
* Action：为了方便沟通和描述，DAS 的每一笔 CKB 交易，都会有一个字段来描述它的意图，这个字段称为 Action；
* xxx交易：这里的 xxx 代指 Action，具体交易结构见其他文档；

## 需求

- 任何账户名都应该能够设置反向解析记录；
- 只有持有地址对应的私钥，能够完成签名才可以设置反向解析；
- 一个地址应该只能解析出一个账户名，一个账户名可以解析出多个地址，即地址和账户名是 n : 1 的关系；
- 同时支持多链地址的反向解析；
- 通过正向解析判断反向解析的账户名是否正确；

## 需要解决的风险

1. 同一个地址可能设置反向解析到多个不同的账户名；
2. 同一个地址可能重复设置反向解析到同一个账户名；
3. 第三者可以设置反向解析到个人的账户名，或因账户所有权转移造成此类情况；

## 方案

### 交易

![reverse-resolution](../../images/reverse-resolution.png)

- 首先用户通过 DeclareReverseResolution 交易声明反向解析，声明时需要选择一个想要声明的地址中的 Cell 作为输入，创建出来的 ReverseRecordCell 只能和输入中的 Cell 相同地址；
- 声明完成后，用户可以通过 RedeclareReverseResolution 交易重新声明反向解析，即修改 ReverseRecordCell；
- 声明完成后，用户可以通过 RetractReverseResolution 撤销反向解析，即销毁 ReverseRecordCell，由于 ReverseRecordCell 的创建可能重复，所以这里可以使用多个 ReverseRecordCell 作为输入；

### 反向解析

不同地址在声明反向解析时没有任何限制，比如任何地址都可以声明自己的反向解析记录为 `alice.bit` ，因此反向解析的第一个约定就是：

> 必须通过正向解析能够获取到该地址，否则就认为反向解析无效。
>
> 正向解析取 address 命名空间下的 value 以及账户的 owner、manager 地址作为判断依据。

同一个地址是可能存在多个 ReverseRecordCell 的，合约并不会保证其唯一性，因此反向解析的第二个约定是：

>对于同一个地址的多个反向解析记录，使用区块高度最大的那一条；
>
>如果多个 ReverseRecordCell 的区块高度一致，就是用在区块中交易索引值最大的那一条；

## 约束

### 账户转移过程中必须清空解析记录

案例：用户 A 注册了名人 V 的账户名 vvvvv.bit，并设置一个正向解析记录指向 A 自己的 ETH 地址 0x1234 ，随后就将此账户名 vvvvv.bit 转至了名人 V 的 ETH 地址 0x0000 。
由于名人 V 从未使用过 CKB 链，因此也不知道此事，但用户 A 却因此可以对外使用 0x1234 地址以 vvvvv.bit 的身分，并且当其他用户发现 vvvvv.bit 的持有地址确实是 0x0000 时，更加可能误以为 0x1234 确实是名人 V 的另一个地址。

