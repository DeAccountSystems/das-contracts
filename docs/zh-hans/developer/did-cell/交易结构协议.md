#  标准交易结构


> 关于各类型 Cell 的具体技术要求，详见 [Cell 结构协议](Cell-结构协议.md) 。

> CKB 官方的 signall 和 multisigh lock script 所需的 CellDeps 不会在下面交易中列出，但是你仍然应该将其添加到交易的 CellDeps 中。

> 所有的交易手续费都是由交易的发起方进行支付。

> 不同于 [AccountCell 相关的交易](../Cell-结构协议.md#accountcell), 为了可组合性考虑。 DidCell 相关的 cells 和 witnesses 不要求他出现在交易中的严格顺序。但是当 DidCell 和 AccountCell 一起出现时， 你需要把遵循 AccountCell 相关的交易要求。 这意味着你需要把 DidCell 相关的 Cell 和 Witness 放在 AccountCell 相关 Cell 和 Witness 之后， 防止校验失败。 DidCell 的操作不需要对应的 Action, 仅校验 DidCell 内的 content 转变是否符合规则。


## 文档术语与约定

> 本文档一切信息需要基于 [RFC-0022 CKB Transaction Structure](https://github.com/nervosnetwork/rfcs/blob/master/rfcs/0022-transaction-structure/0022-transaction-structure.md) 之上进行理解，如果对于 CKB 的交易结构缺乏足够的理解可能会对读懂本文档造成障碍。

| 术语       | 说明                                                                                                     |
|------------|--------------------------------------------------------------------------------------------------------|
| NormalCell | CKB 中的 Cell 都有 lock, type, outputs_data 三个必要属性，这里指的是 type 与 outputs_data 为空的一类 Cell |
| FeeCell    | 支付交易所需的各种费用的 NormalCell                                                                      |
| ScriptCell | 指部署了合约脚本可执行文件的 Cell                                                                        |

| 符号                       | 说明                                                                                                                                                                             |
|----------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [XxxYyyCell]               | 代表 XxxYyyCell 为可选                                                                                                                                                           |
| XxxYyyCell (n)             | 代表 XxxYyyCell 是有序的，这是第 n 个 XxxYyyCell                                                                                                                                  |
| XxxYyyCell {n}             | {4} 代表 XxxYyyCell 有且仅有 4 个<br>{3,} 代表 XxxYyyCell 至少要有 3 个<br/>{,2} 代表 XxxYyyCell 最多有 2 个<br/>{1,4} 代表 XxxYyyCell 数量介于 1 ~ 4 之间                       |
| XxxYyyCell [A]             | 代表交易不同部分的多个 XxxYyyCell 需要满足一致的排序<br/>Inputs/Output/CellDeps 中同样带有 `[A]` 标记的 XxxYyyCell 需要满足一致的排序<br>其中的 A 代表 A 类有序规则，也可以是 B、C |
| ConfigCellXXXX.yyyy        | 指代数据需要去某个 ConfigCell 的 witness 中的特定字段获取，详见[ConfigCell](Cell-结构协议.md#ConfigCell)                                                                        |
| block_hash(XxxYyyCell {n}) | XxxYyyCell {n} 和上述的含意一致， block_hash() 的含意表示要取其中 cell 所在的区块 hash                                                                                            |

> 所有的 hash 都是使用的同一种 hash 算法，即 [ckbhash 算法](https://github.com/nervosnetwork/rfcs/blob/master/rfcs/0022-transaction-structure/0022-transaction-structure.md#crypto-primitives)。

## 相关交易

### 升级到 DidCell

当一个 [AccountCell](../Cell-结构协议.md#accountcell) 的 status 从 Normal(0x00) 置为 Upgraded(0x99) 时, 允许在交易中创建 DidCell. DidCell 的 expire_at 和 output 中对应的 AccountCell相同。


**交易结构**

```
CellDeps:
  ...,     // Deps required by AccountCell
  did-cell-type
Inputs:
  ...,     // Inputs required by AccountCell
  FeeCell // NormalCell used to pay for storage fee for the created DidCell
Outputs:
  AccountCell
  DidCell
  [ChangeCell]
```


### DidCell 转移 owner

DidCell 的转移没有任何额外的 Witness 和 CellDeps， 也没有任何限制。 需要注意过期的 DidCell 也是可以转移的， 由用户判断。

DidCell 可以转移给任意 lock。

**交易结构**

```
CellDeps:
  did-cell-type
  ...     // Any other deps
Inputs:
  DidCell,
  ...     // Any other cells
Outputs:
  DidCell,
  ...     // Any other cells
```


### DidCell 修改解析记录 

可以修改 DidCell 的 content 中的 witness_hash 字段， 并提交对应的 WitnessData. 具体对应关系请参照 [Cell-结构协议](./Cell-结构协议.md)

**交易结构**

```
CellDeps:
  did-cell-type,
  ...     // Any other deps
Inputs:
  DidCell,
  ...     // Any other cells
Outputs:
  DidCell,
  ...     // Any other cells
```


### DidCell 的销毁

只允许过期的 DidCell 的销毁。 当合约发现 Inputs 中存在 DidCell, 而 Outputs 中没有对应的 DidCell 时， 认为是销毁逻辑。 此时合约会要求额外的 CellDeps 存在.

**交易结构**

```
CellDeps:
  did-cell-type,
  TimeCell,
  ConfigCellMain.
  ...     // Any other deps
Inputs:
  DidCell,
  ...     // Any other cells
Outputs:
  DidCell,
  ...     // Any other cells
```