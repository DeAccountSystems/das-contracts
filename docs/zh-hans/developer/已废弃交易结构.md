# 已废弃交易结构

本文档包含了所有已废弃的交易，除非需要解析旧的历史交易，否则可以忽略这些交易。

## 反向解析相关交易 v1

### 声明反向解析(DeclareReverseRecord)

> **Deprecated**！此交易已被废弃，此文档仅供交易解析使用。

该交易可以将一个账户/子账户标记为某个地址的解析记录。

> ReverseRecordCell 的创建是不受数量限制的，当发生重复创建时，会遵循[特定的去重规则](Cell-结构协议.md#ReverseRecordCell)取唯一一个。

**action 结构**

```
table ActionData {
  action: "declare_reverse_record",
  params: [],
}
```

**交易结构**

```
CellDeps:
  das-lock
  balance-cell-type
  reverse-record-cell-type
  ConfigCellMain
  ConfigCellReverseResolution
Inputs:
  BalanceCell {1,}
Outputs:
  ReverseRecordCell
  [BalanceCell]
```

**约定**

- ReverseRecordCell 的 lock 必须和 inputs[0] 的 BalanceCell 一致，如此才能保证反向解析只有拥有对应地址私钥才能声明；
- ReverseRecordCell 必须是 das-lock；

### 变更反向解析(RedeclareReverseRecord)

> **Deprecated**！此交易已被废弃，此文档仅供交易解析使用。

该交易可以修改一条现存反向解析对应的账户。

**action 结构**

```
table ActionData {
  action: "redeclare_reverse_record",
  params: [],
}
```

**交易结构**

```
CellDeps:
  das-lock
  balance-cell-type
  reverse-record-cell-type
  ConfigCellMain
  ConfigCellReverseResolution
Inputs:
  ReverseRecordCell
Outputs:
  ReverseRecordCell
```

**约定**

- 只能修改 ReverseRecordCell.data.account；

### 撤销反向解析(RetractReverseRecord)

> **Deprecated**！此交易将在不久后完全废弃，此文档仅供交易解析使用。

该交易可以撤销一条或多条反向解析声明。

**action 结构**

```
table ActionData {
  action: "retract_reverse_record",
  params: [],
}
```

**交易结构**

```
CellDeps:
  das-lock
  balance-cell-type
  reverse-record-cell-type
  ConfigCellMain
  ConfigCellReverseResolution
Inputs:
  ReverseRecordCell {1,}
Outputs:
  BalanceCell {1,}
```

**约定**

- outputs 中必须包含等额于 inputs 中 ReverseRecordCell 存储费的退款；

## 子账户相关交易 v1

### 创建子账户(CreateSubAccount)

开启子账户后，用户可以通过此交易创建子账户。

**action 结构**

```
table ActionData {
  action: "create_sub_account",
  params: [0x00/0x01], // owner 或 manager 均可创建子账户
}
```

**交易结构**

```
CellDeps:
  das-lock
  account-cell-type
  sub-account-cell-type
  TimeCell
  HeightCell
  [QuoteCell]    // 如果用户设置了自定义脚本，那么就需要将 QuoteCell 放入 cell_deps
  ConfigCellAccount
  ConfigCellSubAccount
  AccountCell
  [CustomScriptCell] // 如果 SubAccountCell 定义了自定义脚本，那么就需要引用该脚本
Inputs:
  SubAccountCell
  BalanceCell {1,}
Outputs:
  SubAccountCell // 子账户的默克尔根必须更新到最终状态
  [BalanceCell]
```

**约定**

- owner 或 manager 均有权限创建子账户；
- AccountCell 必须未处于**宽限期**或之后的状态；
- 未设置自定义脚本时：
  - 每个子账户的注册费等于 `ConfigCellSubAccount.new_sub_account_price`；
- 设置了自定义脚本时：
  - 每个子账户的注册费由自定义脚本约束，注册费需存放于 `SubAccountCell.capacity`，并按照 `ConfigCellSubAccount.new_sub_account_custom_price_das_profit_rate`
    分别在 `SubAccountCell.data.das_profit` 和 `SubAccountCell.data.owner_profit` 记录累计后的利润分配额；
  - 所有输入输出的 BalanceCell 只能使用一致的 lock ；

### 编辑子账户(EditSubAccount)

子账户的持有用户可以通过此交易编辑子账户以进行转让、修改管理员、修改解析记录等操作。

**action 结构**

```
table ActionData {
  action: "edit_sub_account",
  params: [],
}
```

**交易结构**

```
CellDeps:
  das-lock
  sub-account-cell-type
  TimeCell
  HeightCell
  ConfigCellSubAccount
  AccountCell
Inputs:
  SubAccountCell
Outputs:
  SubAccountCell // 子账户的默克尔根必须更新到最终状态
```

**约定**

- AccountCell 必须未处于**宽限期**或之后的状态；
- 这笔交易可以从 SubAccountCell 中扣除的手续费不得高于 `ConfigCellSubAccount.edit_fee` 中配置值；


#### 账户竞拍

##### 开始竞拍（StartAccountAuction）

同时支持 Fomo 和普通竞拍：

- Fomo 竞拍 AccountAuctionCell.prev_bidder_profit_rate 不为 0；
- 普通竞拍时只需要将 AccountAuctionCell.prev_bidder_profit_rate 设为 0 即可。

> 竞拍一旦有人出价，就不能中止，必须等到时间结束后成交。

**action 结构**

```
table ActionData {
    action: "start_account_auction",
    params: [0x00],
}
```

**交易结构**

```
CellDeps:
  das-lock
  account-cell-type
  eip712-lib
  account-auction-cell-type
  TimeCell
  ConfigCellAccount
  ConfigCellSecondaryMarket
Inputs:
  AccountCell
  [FeeCell]
Outputs:
  AccountCell
  AccountAuctionCell
  [ChangeCell]
```

##### 修改竞拍信息（EditAccountAuction）

该交易可以修改存放在 AccountAuctionCell 中的起拍价/描述等信息，分为**可随时修改**和**无人出价前可以修改**两类信息：

- **可随时修改**包括：描述；
- **无人出价前可以修改**包括：起拍价(opening_price)、每次加价的最低比例(increment_rate_each_bid)、起拍时间(started_at)、前一个竞拍者的利润率(prev_bidder_profit_rate)

**action 结构**

```
table ActionData {
    action: "edit_account_auction",
    params: [0x00],
}
```

**交易结构**

```
CellDeps:
    das-lock
    account-aution-cell-type
    TimeCell
    HeightCell
    ConfigCellSecondaryMarket
Inputs:
    AccountAuctionCell
    [FeeCell]
Outputs:
    AccountAuctionCell
    [ChangeCell]
```

##### 取消出售（CancelAccountAuction）

只有在无人出价的时候，才可以通过该 action 取消拍卖。

**action 结构**

```
table ActionData {
    action: "cancel_account_auction",
    params: [0x00]
}
```

**交易结构**

```
CellDeps:
  das-lock
  account-cell-type
  eip712-lib
  account-auction-cell-type
  TimeCell
  HeightCell
  ConfigCellAccount
Inputs:
  AccountCell
  AccountAuctionCell
Outputs:
  AccountCell
  [ChangeCell]
```

##### 出价（BidAccountAuction）

出价竞拍指定账户。

**action 结构**

```
table ActionData {
    action: "bid_account_auction",
    params: [inviter_lock, channel_lock]
}
```

- inviter_lock ，如果竞拍账号的用户有邀请人，可以通过此参数传递邀请人信息，即一个 molecule 编码的 Script 结构，没有邀请人时需要传入 Script 结构的默认值；
- channel_lock ，购买渠道可以通过此参数填入自己的收款地址来收取分成，同样必须是一个 molecule 编码的 Script 结构；

**交易结构**

```
CellDeps:
  das-lock
  offer-cell-type
  account-cell-type
  eip712-lib
  account-auction-cell-type
  TimeCell
  ConfigCellAccount
  ConfigCellSecondaryMarket
  AccountCell
Inputs:
  AccountAuctionCell
  FeeCell
  [IncomeCell] // 如果待分配给 inviter_lock 和 channel_lock 的利润不足 IncomeCell 存储费，那么可以在输入中放入一个空 IncomeCell
Outputs:
  AccountAuctionCell
  [IncomeCell] // 存放分配给 inviter_lock 和 channel_lock 的利润
  [ChangeCell] // AccountSaleCell 的 capacity 必须退还给账户的出售者 das-lock normal cell
```

##### 确认竞拍（ConfirmAccountAuction）

竞拍到期，最新的出价人可以确认竞拍状态，获得竞拍的账号

**action 结构**

```
table ActionData {
    action: "confirm_account_auction"
    params: [0x00],
}
```

**交易结构**

```
CellDeps:
  das-lock
  account-cell-type
  eip712-lib
  account-auction-cell-type
  TimeCell
  ConfigCellAccount
  ConfigCellAuction
Inputs:
  AccountCell
  AccountAuctionCell
Outputs:
  AccountCell
  ChangeCell // 拍卖方获得竞拍所得
```




#### 确认到期账户拍卖结果（ConfirmExpiredAccountAuction）

当账户在其他链上拍卖成功后，如果跨链节点检测到账户在其他链已销毁，就可以通过多签在 ckb 链转移该账户的所有权。

**action 结构**

```
table ActionData {
    action: "confirm_expired_account_auction"
    params: [],
}
```

**交易结构**

```
CellDeps:
  das-lock
  account-cell-type
  TimeCell
  ConfigCellMain
  ConfigCellAccount
  [ConfigCellSubAccount] // 只有存在 SubAccountCell 时才需要
Inputs:
  AccountCell
  [SubAccountCell] // 只有 AccountCell.witness.enable_sub_account 为 true 时才需要
Outputs:
  AccountCell
  [SubAccountCell]
```

**约定**

- AccountCell 必须处于 normal 状态；
- AccountCell 的解析记录必须被清空；
- 如果 AccountCell 开启了子账户，那么 SubAccountCell 应该被保留下来；
- 如果 AccountCell 开启了子账户，那么子账户中的原 owner 的利润和 DAS 的利润必须被退还；
- 如果 SubAccountCell 中的 capacity 和 owner 的利润和 DAS 的利润不一致时，合约会要求按照记录的利润进行退款，是否执行又交易的构造者自行决定；
