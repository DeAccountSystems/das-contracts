## 常量说明

### 黑洞地址

由于 CKB lock 的展示样式的特殊性，因此无论任何 lock 我们从语义上定义黑洞地址为：

> 除特定的合约规则外，没有任何私钥可以解锁的地址。

因此，以下形式的 lock 都可以称之为黑洞地址：

```json
{
  "code_hash": "...", // signhash_all, multisig_all
  "hash_type": "type",
  "args": "0x0000000000000000000000000000000000000000"
}

{
  "code_hash": "...", // das-lock
  "hash_type": "type",
  "args": "0x030000000000000000000000000000000000000000030000000000000000000000000000000000000000"
}
```

### Super Lock

有用 dotbit 合约更新权限的地址：

```json
// testnet
{
  "code_hash": "0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8",
  "hash_type": "type",
  "args": "0xbc502a34a430e3e167c82a24db6f9237b15ebf35"
}

// mainnet
{
  "code_hash": "0x5c5069eb0857efc65e1bca0c07df34c31663b3622fd3876c876320fc9634e2a8",
  "hash_type": "type",
  "args": "0xc126635ece567c71c50f7482c5db80603852c306"
}
```


## 算法说明

### Hash 算法

如无特殊说明，本文均使用 `blake2b` 算法，并配合 CKB 指定的默认参数：

- **output digest size**: `32`
- **personalization**: `ckb-default-hash`

> 本文中的 hash 值除非特别说明都是通过上述 `blake2b` 算法得出。


## 计算公式

注意：因为计算机里没有绝对精准的小数表示方法，所以涉及到整数的除法必然会有精度丢失问题，请严格按照下列计算说明的步骤和公式执行。否则会造成看起来似乎是等价的算法，最后的执行结果会截然不同

### 预注册时的总金额

用户在执行 [预注册账户(PreRegister)](交易结构协议.md#PreRegister) 交易时需要同时支付**存储费**和**注册费**。无论用户支付的是何种货币，都必须在这一步之前兑换为 CKB 才能进行支付。其计算公式为：

```
// 以下伪代码所有数字均为 uint64 类型
存储费 = (AccountCell 基础体积 + 账户字节长度 + 4) * 100_000_000 + 预存手续费
总金额 = 存储费 + 注册费

// 其中注册费必须满足以下条件
if 美元年费 < CKB 汇率 {
  CKB 年费 = 美元年费 * 100_000_000 / CKB 汇率
} else {
  CKB 年费 = 美元年费 / CKB 汇率 * 100_000_000
}
CKB 年费 = CKB 年费 - (CKB 年费 * 受邀折扣率 / 10000)

assert(注册费 >= CKB 年费)
```

- **AccountCell 基础体积** 可以从 `ConfigCellAccount.basic_capacity` 中获取；
- **预存手续费** 可以从 `ConfigCellAccount.prepared_fee_capacity` 中获取；
- **美元年费** 可以从 `ConfigCellPrice.prices` 中获取，单位为 **USDT**；
- **CKB 汇率** 可以从 [QuoteCell](Cell-结构协议.md#QuoteCell) 中获取，单位为 **USDT/CKB**；
- **受邀折扣率** 可以从 `ConfigCellPrice.discount` 中获取；
- 总金额在整个注册的过程中就存放在 `PreAccountCell.capacity` 中；
- 注册费必须大于等于一年的年费，即最少必须注册一年；


### 账户注册/续费成功后的时长计算

在账户注册成功或者续费成功后，用户最终获得的注册时长会按照以下公式进行计算：

```
// 以下伪代码所有数字均为 uint64 类型
if 美元年费 < CKB 汇率 {
  CKB 年费 = 美元年费 * 100_000_000 / CKB 汇率
} else {
  CKB 年费 = 美元年费 / CKB 汇率 * 100_000_000
}
CKB 年费 = CKB 年费 - (CKB 年费 * 折扣率 / 10000)

注册时长 = 注册费 * 365 / CKB 年费 * 86400
```


### 注册成功时的利润分配

当一个账户注册成功时，PreAccountCell 中所携带的注册费就会按照以特定比例分配给整个注册流程中的各个参与者，关于具体某个角色的利润比例可以从 ConfigCellProfitRate 中获取：

```
// 以下伪代码所有数字均为 uint64 类型
利润 = 注册费

if 账户有邀请人 {
  邀请人的利润 = 利润 * 邀请人利润率
}
if 账户有注册渠道 {
  注册渠道的利润 = 利润 * 注册渠道利润率
}
提案创建者的利润 = 利润 * 提案创建者的利润率
提案确认者的利润 = 利润 * 提案确认者的利润率

DAS 的利润 = 利润 - 邀请人的利润 - 注册渠道的利润 - 提案创建者的利润 - 提案确认者的利润
```


### 账户到期后拍卖价格计算公式

当一个账户超过宽限期仍未续费时，就自动进入拍卖流程，拍卖流程参考荷兰拍卖法，报价随时间不断递减直至成交或流拍：

账户的拍卖价格 = 基础价格 + 拍卖时的溢价；

账户的基础价格参见 [预注册时的总金额](#预注册时的总金额)：

溢价的计算公式如下：

$$
Premium = \frac{StartPremium}{2^{\frac{AuctionStartedTime}{24\times 3600}}}
$$

其中：
* Premium: 是拍卖时的溢价；
* StartPremium: 是初始时的溢价，可以从 ConfigCellAccount.expiration_auction_start_premiums 中获取；
* AuctionStartedTime: 是拍卖开始时间，单位为秒；


因为在溢价的计算中，引入了浮点数，导致了精度差异问题，合约引入额外的两个机制保证不会出现过大偏差
1. 增加允许误差表，即允许交易发生的价格在合约计算的基础上下调定值。表的容量为 6，每 5 天为单位， 表值为[10, 1, 0.5. 0.05, 0.01, 0.001]。在计算时，合约根据当前时间除以5天，查表得到误差值，然后减去这个值，作为最终溢价。
比如在发生拍卖的前 5 天，允许拍卖价格低于合约期待价格 10 刀。在 5~10 天，允许拍卖价格低于合约价格 1 刀；
2. 增加时段最低价格表，容量为 60，每 0.5 天为单位，预先计算出价格写到合约里。 合约通过浮点运算得到的溢价不能低于对应时间段的最低价格。防止线上环境合约浮点运算出错，出现极低价格。


